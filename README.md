## Privacy-preserving TEE protoype on a service-oriented environment

***

# Usage:

## Build linux-sgx and linux-sgx-driver

 - Please refer to https://github.com/intel/linux-sgx and https://github.com/intel/linux-sgx-driver.
 - Make sure the SGXSDK version is 2.5 or later.
 - In case the current directory structure of SGXSDK changes, you can use the forked 2.6 version (intact) from my Github.
 
```
git clone https://github.com/StanPlatinum/linux-sgx.git
```

## Build libelf

 - We use the libelf from the elfutils (https://sourceware.org/elfutils/). By default it will generate a static library.

```
git clone https://github.com/StanPlatinum/elfutils4sgx.git
cd elfutils4sgx/elfutils-0.176
autoheader
aclocal -I m4
autoconf
automake -a -c
./configure
make
```

## Build capstone

 - Capstone can be cloned at https://github.com/aquynh/capstone. But it is suggested that users can build capstone using our modified version. Capstone by default will generate a static library (capstone.a). To reduce program size, you can configure capstone to only build x86 instruction decoding support.

```
git clone https://github.com/StanPlatinum/capstone.git
cd capstone
mkdir build
mkdir install-x86
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=../install-x86 -DCAPSTONE_ARCHITECTURE_DEFAULT=OFF -DCAPSTONE_X86_SUPPORT=1
make
```

## Build libz

 - Libz is typically already installed in system directory. In case libz.a is not installed, it can be generated by compiling from source (https://zlib.net/).

## Build llvm/clang

```
git clone https://github.com/StanPlatinum/llvm-project.git
cd llvm-project
mkdir build && cd build
cmake -DLLVM_ENABLE_PROJECTS=clang -G "Unix Makefiles" ../llvm
make
```

## Generate target binary

### Build SGX-Shield

 - SGX-Shield is a brilliant work which we have taken advantage of in our project. It can be cloned at https://github.com/jaebaek/SGX-Shield. Also, it is suggested that you can cloned a modified version at https://github.com/StanPlatinum/SGX-Shield.
 - Please modify $(SGX_Shield_PATH) to where the SGX-Shield is cloned.

### Prepare and pre-link the binary

```
cd ..
cd dynamic-loader/target-program
make
```

### Run other benchmarks

### How to write a pratical SGX application 

 - The entry function is `void enclave()`.
 - The return of an enclave should be `enclave_exit();`.

## Build the loader

```
cd ..
```

### Copy TCB dependencies to Enclave/TrustedLib

```
cp elfutils4sgx/elfutils-0.176/libelf/libelf.a Enclave/TrustedLib
cp capstone/install-x86/lib/libcapstone.a Enclave/TrustedLib
cp /usr/lib/x86_64-linux-gnu/libz.a Enclave/TrustedLib
```

 - Please note that at this time some necessary libs have been copied into the dir Enclave/TrustedLib.

### Set variables in Makefile

```
cd dynamic-loader-checker
vi Makefile
```

 - Please modify $(SGX_SRC_PATH) to where the SGXSDK is installed.
 - And set $(ELFUTILS_PATH) and $(CAPSTONE_PATH) to where the elfutils and capstone have been installed respectively.

### Build the sample enclave

```
make
```

### Try the sample demo

```
./app
```

GL and HF!
